<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>街宣情報フォーム・検索</title>
  <style>
    body { font-family: sans-serif; max-width: 700px; margin: auto; padding: 1em; }
    label { display: block; margin-top: 1em; }
    button { margin-top: 1em; padding: 0.5em 1em; }
    #postResult, #searchResult { margin-top: 1em; font-weight: bold; white-space: pre-wrap; }
    fieldset { margin-top: 2em; padding: 1em; }
    legend { font-weight: bold; }
    .issue { border: 1px solid #ccc; padding: 0.5em; margin-bottom: 1em; }
  </style>
</head>
<body>
  <h1>街宣情報</h1>

  <fieldset>
    <legend>投稿フォーム</legend>
    <form id="gaisenForm">
      <label>都道府県：
        <select name="prefecture" id="postPrefecture" required>
          <option value="">選択してください</option>
          <option value="東京都">東京都</option>
          <option value="大阪府">大阪府</option>
          <!-- 他の都道府県も追加してください -->
        </select>
      </label>

      <label>選挙区：
        <select name="district" id="postDistrict" required>
          <option value="">選択してください</option>
          <option value="東京都選挙区">東京都選挙区</option>
          <option value="大阪府選挙区">大阪府選挙区</option>
          <!-- 他の選挙区も追加してください -->
        </select>
      </label>

      <label>党派：
        <select name="party" id="postParty" required>
          <option value="">選択してください</option>
          <option value="自由民主党">自由民主党</option>
          <option value="立憲民主党">立憲民主党</option>
          <option value="日本維新の会">日本維新の会</option>
          <option value="公明党">公明党</option>
          <option value="国民民主党">国民民主党</option>
          <option value="共産党">共産党</option>
          <option value="れいわ新選組">れいわ新選組</option>
          <option value="参政党">参政党</option>
          <option value="日本保守党">日本保守党</option>
          <option value="社会民主党">社会民主党</option>
          <option value="みんなの党">みんなの党</option>
          <option value="減税日本">減税日本</option>
          <option value="NHK党">NHK党</option>
          <option value="政治家女子48党">政治家女子48党</option>
          <option value="新党くにもり">新党くにもり</option>
          <option value="誠真会">誠真会</option>
          <option value="改革党">改革党</option>
          <option value="無所属">無所属</option>
        </select>
      </label>

      <label>候補者：
        <select name="candidate" id="postCandidate" required>
          <option value="">選択してください</option>
        </select>
      </label>

      <label>日付：<input type="date" name="date" required></label>
      <label>開始時間：<input type="time" name="time" required></label>
      <label>場所（駅名など）：<input type="text" name="place" required></label>
      <label>応援弁士：<input type="text" name="speaker"></label>

      <button type="submit">投稿</button>
      <div id="postResult"></div>
    </form>
  </fieldset>

  
  <fieldset>
    <legend>検索フォーム</legend>
    <form id="searchForm">
      <label>都道府県：
        <select name="prefecture" id="searchPrefecture" required>
          <option value="">選択してください</option>
          <option value="東京都">東京都</option>
          <option value="大阪府">大阪府</option>
          <!-- 他の都道府県 -->
        </select>
      </label>

      <label>選挙区（任意）：
        <select name="district" id="searchDistrict">
          <option value="">選択してください</option>
          <option value="東京都選挙区">東京都選挙区</option>
          <option value="大阪府選挙区">大阪府選挙区</option>
          <!-- 他の選挙区 -->
        </select>
      </label>

      <label>党派（任意）：
        <select name="party" id="searchParty">
          <option value="">選択してください</option>
          <option value="自由民主党">自由民主党</option>
          <option value="立憲民主党">立憲民主党</option>
          <option value="日本維新の会">日本維新の会</option>
          <option value="公明党">公明党</option>
          <option value="国民民主党">国民民主党</option>
          <option value="共産党">共産党</option>
          <option value="れいわ新選組">れいわ新選組</option>
          <option value="参政党">参政党</option>
          <option value="日本保守党">日本保守党</option>
          <option value="社会民主党">社会民主党</option>
          <option value="みんなの党">みんなの党</option>
          <option value="減税日本">減税日本</option>
          <option value="NHK党">NHK党</option>
          <option value="政治家女子48党">政治家女子48党</option>
          <option value="新党くにもり">新党くにもり</option>
          <option value="誠真会">誠真会</option>
          <option value="改革党">改革党</option>
          <option value="無所属">無所属</option>
        </select>
      </label>

      <label>候補者（任意）：
        <select name="candidate" id="searchCandidate">
          <option value="">選択してください</option>
        </select>
      </label>

      <label>応援弁士（任意）：<input type="text" name="speaker"></label>

      <label>この時刻以降の演説を検索：
        <input type="datetime-local" name="fromTime" />
      </label>

      <button type="submit">検索</button>
      <div id="searchResult"></div>
    </form>
  </fieldset>

  <script>
    // 候補者データの例（実際は多くなるはず）
    const candidateData = [
      { name: "東京 太郎", party: "自由民主党", district: "東京都選挙区" },
      { name: "東京 花子", party: "立憲民主党", district: "東京都選挙区" },
      { name: "大阪 一郎", party: "日本維新の会", district: "大阪府選挙区" },
      { name: "大阪 さくら", party: "共産党", district: "大阪府選挙区" },
    ];

    function updateCandidateOptions(districtId, partyId, candidateId) {
      const district = document.getElementById(districtId).value;
      const party = document.getElementById(partyId).value;
      const candidateSelect = document.getElementById(candidateId);

      const filtered = candidateData.filter(c =>
        (!district || c.district === district) &&
        (!party || c.party === party)
      );

      candidateSelect.innerHTML = '<option value="">選択してください</option>';

      filtered.forEach(c => {
        const option = document.createElement("option");
        option.value = c.name;
        option.textContent = c.name;
        candidateSelect.appendChild(option);
      });

      if (filtered.length === 1) {
        candidateSelect.value = filtered[0].name;
      }
    }

    ["postDistrict", "postParty"].forEach(id =>
      document.getElementById(id).addEventListener("change", () => {
        updateCandidateOptions("postDistrict", "postParty", "postCandidate");
      })
    );

    ["searchDistrict", "searchParty"].forEach(id =>
      document.getElementById(id).addEventListener("change", () => {
        updateCandidateOptions("searchDistrict", "searchParty", "searchCandidate");
      })
    );

    // 投稿フォーム送信
    document.getElementById("gaisenForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const data = Object.fromEntries(new FormData(e.target).entries());
      const res = await fetch("https://gaisen-worker.gaisen-bot.workers.dev", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data),
      });
      document.getElementById("postResult").textContent = res.ok ? "投稿成功！" : "投稿失敗...";
      if (res.ok) {
        e.target.reset();
        document.getElementById("postCandidate").innerHTML = '<option value="">選択してください</option>';
      }
    });

    // 検索フォーム送信
    document.getElementById("searchForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const data = Object.fromEntries(new FormData(e.target).entries());

      try {
        const res = await fetch("https://gaisen-worker.gaisen-bot.workers.dev/search", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(data),
        });

        if (!res.ok) {
          throw new Error("検索API呼び出し失敗");
        }

        const issues = await res.json();

        if (issues.length === 0) {
          document.getElementById("searchResult").textContent = "該当する情報はありませんでした。";
          return;
        }

        const html = issues.map(issue => `
          <div class="issue">
            <h3>${issue.title}</h3>
            <pre>${issue.body}</pre>
            <a href="${issue.html_url}" target="_blank" rel="noopener">詳細を見る（GitHub）</a>
          </div>
        `).join("");

        document.getElementById("searchResult").innerHTML = html;

      } catch (err) {
        document.getElementBy
